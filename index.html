<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Calendar Scheduler</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

   .weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    width: 560px;
  }
   .weekday {
     width: auto;
  }
    .calendar {
     display: grid;
     grid-template-columns: repeat(7, 1fr);
     width: 560px;
     gap: 5px;
  }

    .day-block {
      border: 1px solid #ccc;
      width: auto;          /* let grid control width */
      height: 80px;
      margin: 0;            /* spacing now handled by grid gap */
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      cursor: pointer;
      font-size: 12px;
      padding: 5px;
      box-sizing: border-box;
    }

     .day-block .locked {
      color: #777;
      opacity: 0.6;
      cursor: not-allowed;
    }

    .day-block.scheduled {
      background-color: lightgreen;
    }

    .day-block.placeholder {
      opacity: 0;
      pointer-events: none;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .modal {
      background: white;
      padding: 20px;
      border-radius: 8px;
      min-width: 300px;
    }

    .modal label {
      display: block;
      margin-top: 10px;
    }

    .modal select,
    .modal input {
      width: 100%;
      padding: 5px;
      margin-top: 5px;
    }

    .modal button {
      margin-top: 15px;
      padding: 6px 12px;
    }

    .hidden {
      display: none;
    }

    #codeHint {
      color: red;
      display: none;
      font-size: 0.9em;
    }
  </style>
</head>
<body>

  <label for="month">Month:</label>
  <select id="month"></select>

  <label for="year">Year:</label>
  <select id="year"></select>

  <h1>Schedule a Time Block</h1>

  <label for="eventType">Choose Event Type:</label>
  <select id="eventType">
    <option value="Diamond 1">Diamond 1</option>
    <option value="Diamond 2">Diamond 2</option>
    <option value="Diamond 3">Diamond 3</option>
    <option value="Diamond 4">Diamond 4</option>
    <option value="Diamond 5">Diamond 5</option>
    <option value="Batting Cage">Batting Cage</option>
  </select>

  <div class="weekdays" id="weekdays"></div>
  <div class="calendar" id="calendar"></div>

  <!-- Modal -->
  <div id="modalOverlay" class="modal-overlay hidden">
    <div class="modal">
      <h2>Schedule Details</h2>


      <label for="time">Time Block:</label>
      <select id="time">
        <option value="5:30 PM">5:30 PM</option>
        <option value="7:00 PM">7:00 PM</option>
        <option value="12:00 PM">12:00 PM</option>
        <option value="2:00 PM">2:00 PM</option>
      </select>

      <label for="ageGroup">Age Group:</label>
      <select id="ageGroup">
        <option value="10U">10U</option>
        <option value="12U">12U</option>
        <option value="8U">8U</option>
      </select>

      <label for="accessCode">Access Code:</label>
      <input type="text" id="accessCode" placeholder="Enter access code" />
      <small id="codeHint">Access code must be "123456"</small>

      <div>
        <button id="saveBtn" disabled>Save</button>
        <button id="cancelBtn">Cancel</button>
      </div>
    </div>
  </div>

 <script>
    const calendar = document.getElementById('calendar');
    const weekdaysContainer = document.getElementById('weekdays');
    const monthSelect = document.getElementById('month');
    const yearSelect = document.getElementById('year');
    const eventType = document.getElementById('eventType');
  
    const modalOverlay = document.getElementById('modalOverlay');
    const timeSelect = document.getElementById('time');
    const ageGroupSelect = document.getElementById('ageGroup');
    const accessCode = document.getElementById('accessCode');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const codeHint = document.getElementById('codeHint');
    const STORAGE_KEY = (eventType) => `calendarSchedules_${eventType}`;
    const TEAM_PASSWORDS = {
        "A's": "123",
	"Cubs": "234",
	"Dodgers": "345"
    };
	//localStorage.removeItem('calendarSchedules'); (Enable this it the calendar is crashing while loading)


      function getTeamFromPassword(password) {
      return Object.keys(TEAM_PASSWORDS).find(
      team => TEAM_PASSWORDS[team] === password
     );
    }

     
    // Modified to handle specific event types
       function loadSchedules(eventType) {
       return JSON.parse(localStorage.getItem(STORAGE_KEY(eventType))) || {};
    }

      function saveSchedules(data, eventType) {
      localStorage.setItem(STORAGE_KEY(eventType), JSON.stringify(data));
    }
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'];
  
    const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  
    // Populate month dropdown
    months.forEach((month, index) => {
      const option = document.createElement('option');
      option.value = index;  // Set the value to the month index
      option.textContent = month;  // Set the text to the month name
      monthSelect.appendChild(option);
    });

      function attemptDeleteSchedule(dateKey, index, team) {
     const enteredPassword = prompt(
       `Enter password for ${team} to delete this event:`
     );

     if (!enteredPassword) return;

     // Get event type from the selected dropdown
     const selectedEventType = eventType.value;

     if (enteredPassword !== TEAM_PASSWORDS[team]) {
       alert('Incorrect password.');
       return;
     }

     if (!confirm('Are you sure you want to delete this event?')) return;

     // Load the schedules for the specific event type
     const schedules = loadSchedules(selectedEventType);
     schedules[dateKey].splice(index, 1);

     if (schedules[dateKey].length === 0) {
       delete schedules[dateKey];
     }

     saveSchedules(schedules, selectedEventType);
     renderCalendar(); // Re-render the calendar after deleting
   }


    // ðŸ”„ Auto-refresh calendar every minute
    setInterval(() => {
      renderCalendar();
    }, 60 * 1000);

  
    // Populate year dropdown
    for (let y = 2020; y <= 2030; y++) {
      const option = document.createElement('option');
      option.value = y;  // Set the value to the year
      option.textContent = y;  // Set the text to the year
      yearSelect.appendChild(option);
    }
  
    // Set the default values to the current month and year
    const today = new Date();
    monthSelect.value = today.getMonth();  // Set default month to the current month (0-based)
    yearSelect.value = today.getFullYear();  // Set default year to the current year
    eventType.value = 'Diamond 1';  //Set defult event type 
    renderCalendar();

    function renderWeekdayHeaders() {
      weekdaysContainer.innerHTML = weekdays.map(day =>
        `<div class="weekday">${day}</div>`).join('');
    }
  
    
   function renderCalendar() {
     const selectedEventType = eventType.value; // Get the selected event type
     const schedules = loadSchedules(selectedEventType); // Load the schedules for that event type

     const year = +yearSelect.value;
     const month = +monthSelect.value;
     const daysInMonth = new Date(year, month + 1, 0).getDate();
     const firstDay = new Date(year, month, 1).getDay();

     calendar.innerHTML = '';

     // Create empty blocks for days before the start of the month
     for (let i = 0; i < firstDay; i++) {
       calendar.innerHTML += `<div class="day-block placeholder"></div>`;
     }

    // Create blocks for the actual days of the month
     for (let day = 1; day <= daysInMonth; day++) {
       const block = document.createElement('div');
       block.className = 'day-block';
       block.dataset.day = day;
       block.dataset.month = month;
       block.dataset.year = year;
    
       const key = `${year}-${month}-${day}`;
       block.innerHTML = `<strong>${day}</strong>`;

       if (schedules[key]) {
         block.classList.add('scheduled');

         schedules[key].forEach((entry, index) => {
           const div = document.createElement('div');
           div.textContent = `${entry.time} â€¢ ${entry.team} â€¢ ${entry.ageGroup}`;

           const eventDate = parseEventDate(year, month, day, entry.time);
           const locked = isEventLocked(eventDate);

           if (locked) {
             div.classList.add('locked');
           } else {
             div.style.cursor = 'pointer';
             div.addEventListener('click', (e) => {
               e.stopPropagation();
               attemptDeleteSchedule(key, index, entry.team);
             });
           }

           block.appendChild(div);
         });
       }

       block.addEventListener('click', () => openScheduleModal(day, month, year));
       calendar.appendChild(block);
     }
   }
  
    let selectedDayInfo = null;
  
    function openScheduleModal(day, month, year) {
      selectedDayInfo = { day, month, year };
      accessCode.value = '';
      saveBtn.disabled = true;
      codeHint.style.display = 'none';
      modalOverlay.classList.remove('hidden');
    }
  
          accessCode.addEventListener('input', () => {
       const team = getTeamFromPassword(accessCode.value);
       saveBtn.disabled = !team;
       codeHint.textContent = team ? ''  : 'Invalid team password';
       codeHint.style.display = team ? 'none' : 'inline';
       
     });

     function parseEventDate(year, month, day, timeStr) {
     const [time, modifier] = timeStr.split(' ');
     let [hours, minutes] = time.split(':').map(Number);

     if (modifier === 'PM' && hours !== 12) hours += 12;
     if (modifier === 'AM' && hours === 12) hours = 0;

      return new Date(year, month, day, hours, minutes);
        }
      
      function isEventLocked(eventDate) {
      const now = new Date();
      const hours24 = 24 * 60 * 60 * 1000;

      return eventDate < now || (eventDate - now) < hours24;
    }

  
   function teamHasFutureBooking(team) {
     const now = new Date();
     const allEventTypes = [
       'Diamond 1', 'Diamond 2', 'Diamond 3', 'Diamond 4', 'Diamond 5', 'Batting Cage'
     ];

     // Check all event types' schedules
     for (const eventType of allEventTypes) {
      const schedules = loadSchedules(eventType);
    
       for (const key in schedules) {
        const [year, month, day] = key.split('-').map(Number);

        for (const entry of schedules[key]) {
         if (entry.team !== team) continue;

        const eventDate = parseEventDate(year, month, day, entry.time);

          // If the event is in the future, return true
           if (eventDate > now) {
            return true;
           }
         }
       }
     }

        return false;  // ðŸš«No future bookings for the team across all event types
     }
     
    saveBtn.addEventListener('click', () => {
      if (!selectedDayInfo) return;

      const { day, month, year } = selectedDayInfo;
      const selectedEventType = eventType.value; // Get the selected event type
      const scheduleData = loadSchedules(selectedEventType);  // Load schedules for selected event type
       const key = `${year}-${month}-${day}`;

    // Initialize day array if it doesn't exist
        if (!scheduleData[key]) {
        scheduleData[key] = [];
      }

     // Block duplicate time
        const duplicate = scheduleData[key].some(
        entry => entry.time === timeSelect.value
      );
       if (duplicate) {
       alert('That time block is already scheduled for this day.');
        return;
      }

     // Add new time block
       const team = getTeamFromPassword(accessCode.value);
       if (!team) {
        alert('Invalid team password.');
        return;
      }

      // Block if team already has a future booking
     if (teamHasFutureBooking(team)) {
    alert(`${team} already has an active booking across any event type. You can schedule another after it has passed.`);
        return;
    }

      scheduleData[key].push({
        team,
        time: timeSelect.value,
        ageGroup: ageGroupSelect.value
    });

      saveSchedules(scheduleData, selectedEventType);  // Save the schedule under selected event type
      modalOverlay.classList.add('hidden');
      renderCalendar();
    });
  
     cancelBtn.addEventListener('click', () => {
      modalOverlay.classList.add('hidden');
    });
  
    monthSelect.addEventListener('change', renderCalendar);
    yearSelect.addEventListener('change', renderCalendar);
    eventType.addEventListener('change', renderCalendar);

  
    renderWeekdayHeaders();
    renderCalendar();
    </script>
    </body>
